/// hk.pkl - Git hooks configuration for OpenClaw DEV TaskBoard
/// Pattern matched from working enterprise-ai-platform project
amends "package://github.com/jdx/hk/releases/download/v1.35.0/hk@1.35.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.35.0/hk@1.35.0#/Builtins.pkl"

// ============================================
// Python Linters - explicit commands (not Builtins)
// ============================================
local python_linters = new Mapping<String, Step> {
    // Ruff linting
    ["ruff"] {
        glob = "*.py"
        check = "uv run ruff check {{ files }}"
        fix = "uv run ruff check --fix {{ files }}"
    }
    // Ruff formatting
    ["ruff-format"] {
        glob = "*.py"
        check = "uv run ruff format --check {{ files }}"
        fix = "uv run ruff format {{ files }}"
    }
}

// ============================================
// Security & Quality Checks
// ============================================
local security_checks = new Mapping<String, Step> {
    // Prevent accidental secret commits
    ["detect-private-key"] {
        glob = "*"
        check = "hk util detect-private-key {{ files }}"
    }
    // Block large files (>500KB)
    ["large-files"] {
        glob = "*"
        check = "hk util check-added-large-files --maxkb 500 {{ files }}"
    }
    // Check for merge conflict markers
    ["merge-conflicts"] {
        glob = "*"
        check = "hk util check-merge-conflict {{ files }}"
    }
}

// ============================================
// File Hygiene
// ============================================
local file_hygiene = new Mapping<String, Step> {
    // Fix trailing whitespace
    ["trailing-whitespace"] {
        glob = "*.{py,json,yaml,yml,md,toml}"
        check = "hk util trailing-whitespace {{ files }}"
        fix = "hk util trailing-whitespace --fix {{ files }}"
    }
    // End of file fixer
    ["eof-fixer"] {
        glob = "*.{py,json,yaml,yml,md,toml}"
        check = "hk util end-of-file-fixer {{ files }}"
        fix = "hk util end-of-file-fixer --fix {{ files }}"
    }
}

// ============================================
// Hook Definitions
// ============================================
hooks {
    // Pre-commit: security + hygiene + linting
    ["pre-commit"] {
        fix = true
        stash = "git"
        steps {
            ...security_checks
            ...file_hygiene
            ...python_linters
        }
    }

    // Commit message validation
    ["commit-msg"] {
        steps {
            ["conventional-commit"] {
                check = "hk util check-conventional-commit {{commit_msg_file}}"
            }
        }
    }

    // Manual fix command
    ["fix"] {
        fix = true
        steps {
            ...file_hygiene
            ...python_linters
        }
    }

    // Manual check command (CI-friendly)
    ["check"] {
        steps {
            ...security_checks
            ...file_hygiene
            ...python_linters
        }
    }
}
