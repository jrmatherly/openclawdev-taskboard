/// hk.pkl - Git hooks configuration for OpenClaw DEV TaskBoard
/// Uses ruff for Python linting and formatting
/// Integrates with mise for tool management
amends "package://github.com/jdx/hk/releases/download/v1.35.0/hk@1.35.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.35.0/hk@1.35.0#/Builtins.pkl"

// Python linters using ruff (fast Python linter/formatter)
local python_linters = new Mapping<String, Step> {
    // Ruff linting - extremely fast Python linter
    ["ruff"] = (Builtins.ruff) {
        glob = List("*.py")
        batch = true
    }
    // Ruff formatting - consistent code style
    ["ruff_format"] = (Builtins.ruff_format) {
        glob = List("*.py")
        depends = "ruff"
    }
}

// Commit message validators
local commit_validators = new Mapping<String, Step> {
    // Conventional commit validation (feat:, fix:, docs:, etc.)
    ["conventional-commit"] = Builtins.check_conventional_commit
    // Prevent direct commits to main/master branches
    ["no-commit-to-main"] = (Builtins.no_commit_to_branch) {
        env {
            ["NO_COMMIT_TO_BRANCH_ARGS"] = "main master"
        }
    }
}

// File validators for common issues
local file_validators = new Mapping<String, Step> {
    // Check for accidentally added large files
    ["large-files"] = Builtins.check_added_large_files
    // Detect accidentally committed private keys
    ["private-keys"] = Builtins.detect_private_key
    // Fix trailing whitespace in files
    ["trailing-whitespace"] = Builtins.trailing_whitespace
    // Ensure files end with a newline
    ["end-of-file"] = Builtins.newlines
    // Check for merge conflict markers
    ["merge-conflict"] = Builtins.check_merge_conflict
}

hooks {
    // Pre-commit hook: runs before each commit
    ["pre-commit"] {
        fix = true           // Run fix commands to auto-correct issues
        stash = "git"        // Stash unstaged changes before running
        steps {
            ...file_validators
            ...python_linters
        }
    }
    // Commit message hook: validates commit message format
    ["commit-msg"] {
        steps = commit_validators
    }
    // Check hook: for running `hk check` manually or in CI
    ["check"] {
        steps {
            ...file_validators
            ...python_linters
        }
    }
    // Fix hook: for running `hk fix` to auto-fix all issues
    ["fix"] {
        fix = true
        steps {
            ...file_validators
            ...python_linters
        }
    }
}

// Fail fast for quicker feedback during development
fail_fast = true
